# 哈密尔顿蒙特卡洛（HMC）采样方法实验报告

## 1. 模型描述
本实验的目标是使用哈密尔顿蒙特卡洛（Hamiltonian Monte Carlo, HMC）采样方法对如下给定的**混合高斯分布**进行采样：

$$
p(x) = 0.3\mathcal{N}(x \mid 4, 0.3) + 0.7\mathcal{N}(x \mid 7, 2)
$$

其中 $\mathcal{N}(\mu, \sigma^2)$ 表示均值为 $\mu$ 且方差为 $\sigma^2$ 的正态分布。  
我们通过对数形式的目标分布以及其梯度，实现了 HMC 的一系列步骤（动量初始化、Leapfrog 积分、Metropolis 接受–拒绝等），来完成从此混合分布中采样的任务。

## 2. 训练方式
由于 HMC 通过在目标分布上"模拟"一个哈密尔顿动力系统来采样，需要选择合适的 步长 ($\varepsilon$) 和 Leapfrog 步数 ($L$) 等参数，以在采样效率与准确度之间取得平衡。主要策略如下：

- 步长 ($\varepsilon$)：设为 0.05。过大的步长会导致能量偏差过大、接受率下降；过小的步长会使得采样变慢，计算开销增大。
- Leapfrog 步数 ($L$)：设为 20。增加 $L$ 值有助于更加充分地探索目标分布，但也会带来额外的计算成本。
- 初始位置 (init_position)：设为 5.5，其接近理论均值 $\mu = 0.3 \times 4 + 0.7 \times 7 = 6.1$，有利于加速初期迭代。

在每一步采样中：
1. 随机初始化动量 $p$；
2. 计算当前系统哈密顿量；
3. 利用 Leapfrog 积分更新 $(x, p)$；
4. 计算新系统哈密顿量，进行 Metropolis 接受-拒绝步骤。

## 3. 测试实验设置及其结果

### 3.1 消融实验
为了研究不同参数对HMC采样效果的影响，我们进行了消融实验，测试了以下参数组合：
- 步长(ε)：[0.01, 0.05]
- Leapfrog步数(L)：[10, 20]
- 初始位置：[4, 5.5]

实验结果显示：
1. **步长影响**：
   - ε=0.05时普遍获得更好的采样效果，KL散度和MAD都明显低于ε=0.01
   - 较大步长在保持高接受率(>99.95%)的同时，能更有效地探索参数空间

2. **Leapfrog步数影响**：
   - L=20通常比L=10表现更好，特别是在评估指标的稳定性上
   - 更多的Leapfrog步数帮助系统更充分地探索目标分布

3. **初始位置影响**：
   - 初始位置在5.5时（接近理论均值6.1）通常能获得更好的采样效果
   - 合适的初始位置有助于加快采样收敛速度

### 3.2 最优参数设置
基于消融实验结果，我们选择了以下最优参数组合：
- 步长(ε) = 0.05
- Leapfrog步数(L) = 20
- 初始位置 = 5.5
- 采样数量 = 20000
- Burn-in期 = 1000

使用这组参数，我们获得了以下性能指标：
- KL散度：0.0080
- 平均绝对偏差(MAD)：0.0100
- 理论均值 vs 采样均值：6.1000 vs 6.2222 (误差：0.1222)
- 理论方差 vs 采样方差：3.3800 vs 3.3317 (误差：0.0483)
- 接受率：99.95%

这些结果表明：
1. 采样分布与目标分布高度吻合（低KL散度和MAD）
2. 样本统计特性与理论值非常接近（小的均值和方差误差）
3. 采样效率极高（接近100%的接受率）

### 3.3 可视化分析
如下图所示，可视化结果包含三个部分：

<div align="center">
  <img src="HMC采样结果.png" alt="HMC采样结果" width="800"/>
  <p><em>图1：HMC采样结果可视化</em></p>
</div>

1. **分布对比**（上图）：
   - 红线表示目标分布
   - 青色直方图表示HMC采样结果
   - 两者高度重合，验证了采样的准确性

2. **采样轨迹**（中图）：
   - 展示了前1000步的采样过程
   - 轨迹显示出良好的混合性和遍历性
   - 能够有效地在两个模态之间跳转

3. **评估指标**（下图）：
   - 左侧展示了分布拟合相关的指标（KL散度、MAD等）
   - 右侧展示了统计特性相关的指标（方差、接受率等）
   - 所有指标都表明采样效果优异

## 4. 相关讨论与展望

1. **算法特性分析**
   - HMC通过引入动量变量和哈密尔顿动力系统，相比传统的Metropolis-Hastings算法能更有效地探索高维空间
   - Leapfrog积分器的对称性质保证了细致平衡条件，这是算法收敛性的重要保证
   - 在混合高斯分布这种多模态情况下，算法展现出良好的模态间跳转能力

2. **计算效率考虑**
   - 每次迭代需要多次计算梯度，在高维或复杂分布情况下可能带来较大计算开销
   - 可以考虑使用随机梯度版本的HMC或引入预处理技术来提高效率
   - 参数自适应调整策略（如NUTS算法）可能是一个值得探索的改进方向

3. **潜在改进方向**
   - **自适应机制**：实现No-U-Turn Sampler (NUTS)等自适应算法，自动调整步长和步数
   - **并行化策略**：利用并行链采样，可以提高采样效率并评估收敛性
   - **分布扩展**：将当前实现扩展到更复杂的分布族，如多维混合高斯或其他复杂分布
   - **诊断工具**：增加Gelman-Rubin统计量等收敛性诊断工具
   - **可视化增强**：添加能量轨迹、相空间轨迹等更丰富的可视化内容

通过本实验，我们不仅验证了HMC在混合分布采样上的有效性，也为后续在更复杂场景下的应用奠定了基础。未来的工作将主要集中在算法的自适应性增强、计算效率提升以及应用场景扩展等方面。
